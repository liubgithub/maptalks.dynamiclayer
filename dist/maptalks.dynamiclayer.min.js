/*!
 * maptalks.dynamiclayer v2.0.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],t):t(e.maptalks=e.maptalks||{},e.maptalks)}(this,function(e,t){"use strict";function r(e,t){for(var r=Object.getOwnPropertyNames(t),n=0;n<r.length;n++){var o=r[n],i=Object.getOwnPropertyDescriptor(t,o);i&&i.configurable&&void 0===e[o]&&Object.defineProperty(e,o,i)}return e}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):r(e,t))}var a=function(e){function r(t,i,a){var s;n(this,r);var p=a||{},c=o(this,e.call(this,t,a));return c.layerOptions=p,c.serviceUrl=i,s=c,o(c,s)}return i(r,e),r.prototype._checkUrl=function(e){if(e instanceof String){var t=e.substr(e.length-2,1);return"/"!==t}return!1},r.prototype.prepareToDraw=function(){var e=this.getMap();if(e){var t=e.getSize();return t}},r.prototype.draw=function(e,r,n){var o=this,i=this.serviceUrl,a="../proxy/proxy.ashx",s=a;if(this._checkUrl(i))return void console.log("service url is invalid");var p=this.getMap(),c=n,f=p.getExtent(),l=f.xmin+","+f.ymin+","+f.xmax+","+f.ymax,u=c.width+","+c.height,y=this.layerOptions.layerId?"show:"+this.layerOptions.layerId:"",h="/export?bbox="+l+"&bboxSR=&layers="+y+"&layerDefs=&size="+u+"&imageSR=&format=png&transparent=true&dpi=&time=&layerTimeOptions=&dynamicLayers=&gdbVersion=&mapScale=&f=json";t.Ajax.post({url:s},"url="+encodeURIComponent(i)+"&filter="+encodeURIComponent(h),function(r,n){if(!r){var i=t.Util.parseJSON(n),a=new Image(c.width,c.height);a.src=i.href,a.onload=function(){e.drawImage(a,0,0,c.width,c.height),o.completeRender(),o.fire("drawend",{img:a})}}})},r}(t.CanvasLayer);e.DynamicLayer=a,Object.defineProperty(e,"__esModule",{value:!0})});